---
title: "FA Home Work 1"
author: "Ilya Fominykh"
date: "09 06 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Скачаем и подключим библиотеки

```{r, eval=FALSE}
library(haven) 
library(dplyr)
library(foreign)
library(psych)
library(GGally)
library(GPArotation)
library(nFactors)
library(lavaan)
library(semTools)
library(semPlot)
```

```{r, include=FALSE}
library(haven) 
library(dplyr)
library(foreign)
library(psych)
library(GGally)
library(GPArotation)
library(nFactors)
library(lavaan)
library(semTools)
library(semPlot)
```

**Задание 0.**Выбрать любую страну, которая Вам кажется любопытной для анализа в контексте поставленной содержательной задачи. Поясните свой выбор.

Так как наша содержательная задача – "выделить разные понимания-трактовки демократии", а в контексте оригинального исследования ( Welzel & Kirsch 2017) указывалось, что эти трактовки свойственны для режимов, находящихся между автократиями и демократиями, нам необоходимо выбрать любую из стран, входящих в число semi-autocracies, или полуавтократий. В этом контексте, для нас хорошо подойдет кейс России, которую в сложившейся исследователькой традиции принято относить как раз к таким режимам, сочетающим как элементы демократии, так и элементы автократии без решающего превалирования одних над другими.

Теперь, загрузим данные WVS6 Russia, А также удалим лишние данные, не имеющие отношения к блоку вопросов по трактовке демократии (переменные V131 – V139):

```{r}
WVS <- read_dta(file.choose())
WVS_dem <- dplyr::select(WVS, V131, V132, V133, V134, V135, V136, V137, V138, V139)
```

После этого, удалим ответы "не знаю", а также отсутствующие ответы. В оригинальной кодировке им соответсвуют значения -1 и -2. Также удалим значения -5, в т.ч. не несущие для нас содержательного смысла.

```{r}
WVS_dem_clean <- WVS_dem
WVS_dem_clean[WVS_dem_clean == -2] <- NA
WVS_dem_clean[WVS_dem_clean == -1] <- NA
WVS_dem_clean[WVS_dem_clean == -5] <- NA
WVS_dem_cl <- na.omit(WVS_dem_clean)
```

**Задание 1.** Запишите вид модели разведывательного ФА в данном случае. Дайте максимально полную интерпретацию полученным результатам. Сколько латентных факторов разумно выделить? Насколько полученные результаты согласуются с Вашими исходными предположениями? Обсудите возможные решения. Проинтерпретируйте меры качества решения.

В первую очередь, проверим данные на применимость ФА

```{r}
corr <- cor(WVS_dem_cl)
corr
ggcorr(WVS_dem_cl, nbreaks = 5, label = T, size = 4, hjust = 0.9)
```

Как мы видим, корреляции между рядом показателей принимают значение от -0.2 до 0.2. Но большинство корреляций находится в радиусе от 0.3 до 0.6. В общем виде, это не дает нам однозначного ответа, будет ли применение ФО продуктивно на этих данных, но и не говорит об обратном. Резюмируя, данные скорее подходят, чем не подходят для реализации ФО, требуется дополнительная проверка.

```{r}
KMO(WVS_dem_cl)
```

Общий результат = 0.87. Такой результат считается довольно хорошим и указывает на то, что применение ФА на указанной выборке допустимо. Так, значения критерия Кайзера-Майера-Олкина находятся выше средних значений: недопустимым применение ФА cчитается, если общий результат по критерию менее 0.5.

```{r}
VSS.scree(corr)
```

На основе графика Каменистой осыпи видно, что скорость изменения собственных значений компонет уменьшается на третьей компоненте. Прямая линия на единице позволяет одновременно применить критерий Кайзера: он указывает на то, что только две компоненты принимают значение более 1. Таким образом, оба критерия указывают на то, что нам стоит извлекать два фактора.

Дополнительно, обратимся к параллельному анализу, чтобы определить, сколько факторов нам необходимо извлекать.

```{r}
eigen <- eigen(cor(WVS_dem_cl)) 
p <- parallel(var = ncol(WVS_dem_cl), subject = nrow(WVS_dem_cl), rep = 1000)$eigen$mevpea
screeplot <- nScree(x=eigen$values, aparallel = p)
plotnScree(screeplot)
```

Как мы видим, значения по исходной выборке превышают те значения, которые мы получили по параллельному анализу в двух случаях. Так, подтверждающий анализ подтверждает те выводы, к которым мы пришли ранее после применения критерия Кайзера и критерия Кеттела. Поэтому, резюмируя все использованные методы, для последующего анализа нам **нужно извлечь два фактора.** 

Когда мы узнали количество факторов, мы можем реализовать разведывательный факторный анализ. Для начала, сделаем ортогональное вращение

```{r}
efa1 <- fa(r = corr, nfactors = 2, fm = "pa", rotate = "varimax") # pa - principal factor FA
efa1
```

Так, мы видим, что значения специфичности(u2) в большинстве случаев превышают значения общности(h2), что является плохим показателем, так как содержательно они отражают соотвественно долю объясненной и необъясненной вариации параметра. Важно также заметить, что значения показателя RMSR ниже 0.08, что говорит о низком качестве модели. Эти меры качества решения указывают на то, что полученная модель объясняет сравнительно мало: мы упустили много информации, ушедшей в ошибку. В какой-то степени, такие результаты не согласуются с теми ожиданиями, которые у нас были вначале: высокие значения критерия Кайзера-Майера-Олкина и наличие высоких корреляций указывали на то, что значения общности будут выше полученных.Поэтому есть вероятность, что мы недоучли какой-то фактор. Чтобы повысить качество модели, от нас потребуется внесение изменений в её спецификацию и тестирование на возможность ослабить какие-то допущения. В заключение, нужно отметь, что значения Multiple R square of scores with factors, эквивалентные значению R^2 из регресионного анализа, и показывающие квадрат корреляции между наблюдаемыми и предсказанными значениями в целом соответствуют средним значениям этих показателей в плане объясненной вариации этой модели.

Сумма квадратов нагрузок для каждого из факторов (SS loadings) содержательно показывает, какую часть вариации объясняет этот фактор. Так, например, 3.23 - это часть общей вариации, которую объясняет первый фактор. пропорционально объясненная доля вариации (proportion var) рассчитывается на основе этого значения, она показывает какую часть от вариации в % отношении объясняет тот или иной фактор. Так, например, 0.36 - это доля общей вариации, которую объясняет первый фактор.

также, узнав коэффициенты, мы можем записать модель, специфичную для РФА в нашем случае:

V_i=PA1_ixF_1+PA2_ixF_2+e

где V - переменная из исходного датасета, PA - коэффициенты при факторе, или факторные нагрузки (их можно узнать из выдачи выше для каждой конкретной переменной и каждого конкретного фактора), F - факторы модели (ранее мы указали, почему извлекаются 2 фактора), а e - ошибка.

Для содержательной интерпретации факторов,Повторим содержательное значение переменных:

V131 "отношение к налогам в пользу бедных"
V132 "важность мнения религиозных лидеров" 
V133 "отношение к свободным выборам" 
V134 "пособие для безработных"
V135 "Армия берет власть, если правительство некомпетентно" 
V136 "отношение к гражданским правам" 
V137 "обеспечение государством равенства доходов" 
V138 "люди подчиняются правителям" 
V139 "у мужчин и женщин должны быть равные права" 

А также выгрузим только значимые факторные нагрузки:
```{r}
print(efa1$loadings, cutoff=0.3)
```

Так, первый фактор со сравнительно большими факторными нагрузками влияет на переменные v131, V132, V133, V136, V137, V139. Они же отличаются высокой степенью факторной нагрузки на первый фактор(последний столбец com в выдаче). Так, эти переменные содержательно связаны с равенством прав и равенством доходов населения. В этом же ключе мы можем интерпретировать содержавтельное значение первого фактора: "важность обеспечения равенства прав и доходов".

Содержательная интерпретация второго фактора технически сложнее, так как он объясняет сравнительно небольшую долю общей вариации. Тем не менее, мы видим, что в него с наибольшими факторными нагрузками входят переменные v132, v135 и v138, которые можно связать с наличием сильной и авторитетной лидерской фигуры(например, в лице армии или церкви). Условно, возможна интерпретация как "важность наличия у лидера опоры для власти". Эта опора может выражаться как в уважении и авторитете, так и в военной мощи и лидерской готовности взять власть, реализовывать свои решения.

В последнюю очередь, реализуем РФА, но не с ортогональным, а с косоугольным вращением.

```{r}
efa2<- fa(r = corr, nfactors = 2, fm = "pa", rotate = "oblimin")
efa2
```

Как мы видим, в результате факторные нагрузки стали более выраженными.

**Задание 2.** Сформулируйте гипотезы относительно уточнения спецификации модели, в частности, на основе разведывательного факторного анализа. Реализуйте конфирматорный факторный анализ на Ваших данных. Предложите максимально полную интерпретацию (факторные нагрузки, общности и специфичности), прокомментируйте меры качества, уточните модель (на основе EPC и/или модификационных индексов), представьте путевую диаграмму для итоговых результатов.

После РФА мы выяснили, сколько у нас дожно быть факторов, а также выдвинули имеющие эмпирические основания предположения об их качественном содержании. Это позволяет нам, учитывая и факторные нагрузки в РФА, выдвигать гипотезы по поводу того, что должны в себя включать факторы ПФА. Иными словами, опираясь на РФА, мы специфицируем модель ПФА.  

Так как РФА основан на жестких допущениях (таких, как равенство Cor между факторами 0, отсутствию корреляции между специфичностями и ошибками, что неправдоподобно в контексте наших данных и ранее выделенного содержательного значения факторов), нам необходимо провести дополнительно ПФА. 

```{r}
cfa1_1 <- 'equality =~ V131 + V133 + V134 + V136 + V137 + V139
power =~ V132 + V135 + V138'

model1 <- cfa(cfa1_1, WVS_dem_cl)
summary(model1, fit.measures = TRUE, standardized = TRUE)
```

Мы видим, что у нас применялся ММП. Так, мы имеем возможность сравнить разные спецификации модели. Помимо этого, мы видим значение статистики хи-квадрат (test statistic), по которой мы можем проверить гипотезу о незначимости модели. Также в выдаче есть степени свободы (Degrees of freedom) - по ним мы можем идентифицировать модель: положительное кол-во степеней свободы свидетельствует о идентифицируемости модели, возможности сделать статистическую инференцию. 

Но test statistic очень сильно зависит от размера выборки - если n велико, мы будем чаще отвергать H0. Чтобы учесть это, обратимся к критерию RMSEA - он делает поправку на размер выборки и кол-во параметров модели. Чем ниже его значения, тем лучше Если взять его границу как условно равную 0.05, то мы должны прийти к выводу, что качество нашей модели весьма низкое. К тем же выводам мы придем, если мы посмотрим на доверительные интервалы. Наш Pvalue невысок, а значит RMSEA не находится в пределе допустимых значений (мы отвергаем H0)

Обратимся также к индексам Такера-Льюиса и CFI. Эти индексы сравнимают нашу и базовую модель без совместной изменчивости. CFI уже приведен к шкале от 0 до 1. Чем ближе к 1 - тем выше качество модели. Пороговые значения ~ выше 0.9-0.95. В нашем случае, согласно обеим индексам, качество модели сравнительно низкое. 

Индекс SRMR измеряет среднее отклонение наблюдаемых значений совариации от предсказанных моделью(т.е. то, насколько велики ошибки в модели). Пороговое значение - 0.08, наша модель, опять, превышает данное пороговое значение (0.124).

Как мы можем видеть, первые показатели каждого фактора (V131 AND V132) были выбраны как референтные. На основе их измеряется вариация каждого фактора. Первый столбец - нестандартизированное решение, посдледний - стандартизированное. Если нам надо понять сопоставимость результатов по подгруппам, нам нужно обращаться к нестандартизированным решениям. Но в нашем случае вопрос обстоит не так.

В нашем случае, Pvalue ковариации факторов очень велик, что указывает на её незначимость.

Теперь, мы можем визуализировать результаты:

```{r}
semPaths(model1, "std", rotation = 2,   
           nodeLabels = c("V131",
                        "V133",
                        "V134",
                        "V136",
                        "V137",
                        "V139",
                        "V132",
                        "V135",
                        "V138",
                         "equality", "power"), 
colFactor = 0, sizeMan = 10, sizeMan2 = 5, sizeLat = 10, edge.color = "red",
edge.label.cex = 1, esize = 1, mar = c(3,10,3,10))
```

Стоит указать, что пунктирные линии соответствуют референтным показателям.

Покажем, как интерпретируются факторные нагрузки при стандартизированном решении (отражены в "стрелочках" графика). Начнем с Фактора "power" и переменной v138 (cодержательное значение факторов и переменных дано выше, в нашем случае оно соответствует 0.24). Во-первых, интерпретация факторной нагрузки возможна как корреляция между фактором и показателем. Вторая возможная интерпретация - возведение факторной нагрузки в квадрат, чтобы получить ту долю вариации показателя, которую объясняет фактор. В указанном случае, эта доля составит 0.06. (такую часть вариации V138 объясняет "power", этот же показатель называется "общность").В-третьих, возможна интерпретация, параллельная интерпретации коэффициентов в регрессионном анализе: при увеличении "power" на 1 стандартное отклонение, на 0.24 увеличивается  стандартное отклонение V138 при прочих равных условиях. Все эти же интерпретации можно привести для любой другой факторной нагрузки модели. Вариации ошибок, отраженные красными круглыйми стрелочками - это "специфичности" (т.е. необъясненные фактором вариации ошибки) В нашем случае, специфичность V138 будет соответствовать значению 0.94. По той же логике, можно узнать специфичность любого из параметров.

Получив такие результаты, от нас потребуется уточнение модели.

```{r}
mepc <- modindices(model1, sort. = TRUE)
mepc
```

Модификационный индекс (mi) - результат сравнения более и менее экономной моделей. Мы последовательно добавляем параметры в модели. Параметры, обозначенные двумя тильдами это корреляции между специфичностями. Высокое приращение в значениях хи-квадрат указывает на то, что модель стала лучше (в обратном случае, у нас отсутствуют статистически значимые различия). mi есть Значения статистики хи-квадрат с одной степенью свободы, и все значения выше 3.84 (критическая точка хи-квадрат для 1й степени свободы) являются значимыми на уровне доверия 0.95. Значимость результатов не гарантирует большой вклад новоо параметра! Чтобы реально оценить вклад параметра, нужно обратиться к стандартизированным значениям критерия (epc). Стандартизированный вклад EPC показывает последний столбец (sepc.lv)

У нас не самое лучшее качество модели - поэтому мы обратимся к значениям модификационного индекса(mi),чтобы понять, что стоит внести в модель. Если бы качество модели было хорошим, мы бы обратили внимание на вклады (sepc.lv). 

```{r}
cfa2 <- 'equality =~ V131 + V133 + V134 + V136 + V137 + V139
power =~ V132 + V135 + V138
equality =~ V138'
model2 <- cfa(cfa2, WVS_dem_cl)

summary(model2, fit.measures = TRUE, standardized = TRUE)
```

Если бы мы учли в модели дополнительно ковариации, (прописав, например, V132	~~ V135) В результате, в выдаче у нас возникла бы не только совместная изменчивость факторов, но и совм. изменчивость между специфичностями. Её Pvalue указывала бы на то, стоит или нет его оставлять в модели (низкий Pvalue свидетельствовал бы о значимости). 

Также у нас вырастает показатель RMSEA, что указывает на повышение качества модели.Кроме того, сравнивая с базовой моделью, у нас также выросли CFI И TLI, что также отмечает рост качества модели. Не смотря на это, модель все равно не преодолевает пороговые значения, позволяющие считать её хорошей, и в дальнейшем нам потребуется снова уточнять модель, внося туда влиятельные ковариации.Пока что, проведем тест и проверим, какую модель стоит предпочесть:

```{r}
anova(model1, model2)
```

Тот факт, что наше значение Pr(>Chisq) невелико, свидетельствует в пользу того, что нам стоит предпочесть модель 2 (нулевая гипотеза о отсутствии статистически значимой разницы между моделями не подтверждается). Так, мы делаем вывод, что учет V138 в факторе equality увеличивает качество модели, и нам стоит учитывать эту переменную в этом факторе.
