---
title: "Практикум 1. Модели с переменными взаимодействия"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Скачаем и подключим библиотеки

```{r, eval=FALSE}

library(haven) 
library(dplyr)
library(ggplot2)
library(margins)
library(psych)
library(memisc)
```

```{r, include=FALSE}

library(haven) 
library(dplyr)
library(ggplot2)
library(margins)
library(psych)
library(memisc)
```


**Задание 1.** Постройте модель регрессии (1), в которой откликом выступает эффективность
государственного управления (wbge), предикторами – уровень демократии (fhpolity), логарифм
ВВП на душу населения (lngdppc), переменная взаимодействия между уровнем демократии и
логарифмом ВВП на душу населения. Проинтерпретируйте оценки коэффициентов при всех
предикторах.

Построим модель и проинтерпретируем коэффициенты

```{r}
data <- read_dta("tvims3_lab1_2.dta")
head(data)

model1 <- lm(wbge ~ fhpolity + lngdppc + lngdppc:fhpolity, data = data)
summary(model1)
```

Константа: Среднее значение эффективности государственного управления в странах будет равно -2.32032 при условии того, что логарифм от ВВП на душу населения и уровень демократии равны 0, как и переменная взаимодействия

fhpolity: При изменении демократичности режима на 1 при условии, что логарифм от ВВП на душу населения =0, в среднем значение эффективности государственного управления будет уменьшаться на 0.42174 

lngdppc: При изменении логарифма от уровня ВВП на душу на 1 в странах, где уровень демократичности по fhpolity оценен как = 0,в среднем значение эффективности государственного управления будет в среднем увеличиваться на 0.18247 

Переменная взаимодействия lngdppc:fhpolity: При изменении демократичности режима на 1  взаимосвязь логарифма от ВВП на душу населения и эффективности государственного управления становится более выраженной положительной: коэффициент взаимосвязи в среднем увеличивается на 0.06088. (возможна зеркальная интерпретация)


**Задание 2.** Преобразуйте шкалу переменной логарифма ВВП на душу населения так, чтобы
она включала значение 0. Оцените модель регрессии (2) с преобразованной переменной, при
этом сохраните такую же спецификацию, как и в предыдущей модели. Интерпретация оценок
каких коэффициентов изменится по сравнению с соответствующими оценками коэффициентов
в модели (1)? Приведите новую интерпретацию.

```{r}
data1 <- data
data1 <- na.omit(data1)
data1$lngdppc_new = data1$lngdppc - mean(data1$lngdppc) 
describe(data1$lngdppc_new)
```

Мы центрировали данные так, чтобы шкала переменной логарифма ВВП на душу населения включала значение 0, заново построим модель

```{r}
model2 <- lm(wbge ~ fhpolity + lngdppc_new + lngdppc_new:fhpolity, data = data1)
summary(model2)
```

Как мы можем видеть, уровни значимости остались прежними, но при этом значения константы и  коэфициента при предикторе fhpolity я изменились. Это изменит некоторые даваемые нами интерпретации.

Константа: Среднее значение эффективности государственного управления в странах будет равно -0.77854 при условии того, что центрированный логарифм от ВВП на душу населения и уровень демократии равны 0, как и переменная взаимодействия

fhpolity: При изменении демократичности режима на 1 в странах, где логарифм от ВВП на душу населения =0, в среднем значение эффективности государственного управления будет увеличиваться на 0.09270 

lngdppc: При изменении логарифма от уровня ВВП на душу на 1 в странах, где уровень демократичности по fhpolity оценен как = 0,в среднем значение эффективности государственного управления будет увеличиваться на 0.18247 

Переменная взаимодействия lngdppc:fhpolity: При изменении демократичности режима на 1  взаимосвязь логарифма от ВВП на душу населения и эффективности государственного управления становится более выраженной положительной: коэффициент взаимосвязи в среднем увеличивается на 0.06088. (возможна зеркальная интерпретация)


**Задание 3.** Рассчитайте предельные эффекты изменения логарифма ВВП на душу населения на эффективность государственного управления при разных значениях уровня демократии (fhpolity).

Cредние значения предельных эффектов
```{r}
margins_model1 <- margins(model2)
summary(margins_model1)
```
Полученные предельные эффекта являются значимыми(т.к. Pvalue невелико + доверительные интервалы не накрывают 0)

Значения предельных эффектов при разных значениях уровня демократии
```{r}
margins_model2 <- margins(model2, at = list(fhpolity = 0:10))
summary(margins_model2)
```

**1.**Проинтерпретируйте результаты, в частности, укажите, как изменяется предельный эффект с ростом уровня демократии на единицу шкалы измерения.

Логарифм ВВП на душу населения оказывает положительный эффект на зависимую переменную. При увеличении уровня демократии на 1 в среднем значение предельного эффекта будет увеличиваться в соответствие с данными из второй таблицы (пересечение строчек lngdppc и столбца AME).

**2.**Постройте график, демонстрирующий изменение предельного эффекта в зависимости от
уровня демократии (по оси абсцисс – уровень демократии). Проинтерпретируйте данный
график.

```{r}
ggplot(margins_model2, aes(x = fhpolity)) + 
  geom_line(aes(y = dydx_lngdppc_new)) +
  geom_line(aes(y = dydx_lngdppc_new+1.96*sqrt(Var_dydx_lngdppc_new)), linetype = 2) +
  geom_line(aes(y = dydx_lngdppc_new-1.96*sqrt(Var_dydx_lngdppc_new)), linetype = 2) +
  geom_hline(yintercept = 0) +
  ggtitle("Conditional effect") +
  xlab("fhpolity") + ylab("Marginal effect of lngdppc")
```

График повторяет ранее данный нами вывод - при увеличении уровня демократии предельный эффект ВВПНД на зависимую переменную увеличивается, при этом доверительные интервалы не захватывают 0, т.е. он значим.


**Задание 4.** Оцените модель регрессии (3), в которой откликом выступает эффективность государственного управления (wbge), предикторами – индикатор политического режима, представленный в бинарной шкале (dembinary), логарифм ВВП на душу населения (lngdppc), переменная взаимодействия между политическим режимом (dembinary) и логарифмом ВВП на душу населения. 

```{r}
model3 <- lm(wbge ~ dembinary + lngdppc_new + dembinary:lngdppc_new, data=data1)
summary(model3)
```
Рассчитайте и проинтерпретируйте предсказанные значения эффективности государственного управления при максимальном значении логарифма ВВП на душу населения в демократических и недемократических политических режимах.

х учитывает демократические режимы
у - не учитывает

```{r}
x=-0.42193+0.41609+0.37826*1.99+0.42344*1.99
x

y=-0.42193+0.37826*1.99
y
```


**Задание 5.** Чему равны оценки констант и коэффициента при предикторе «логарифм ВВП на душу населения» в моделях, оцененных на отдельных выборках (такие выборки сформированы на основании значения показателя dembinary)? Зависимой переменной остается эффективность государственного управления. Покажите, как можно получить эти оценки коэффициентов из оценок модели (3).

```{r}
interactions1 <- subset(data1, dembinary == 1)
model3_1 <- lm(wbge ~ lngdppc_new, data = interactions1)
summary(model3_1)
interactions0 <- subset(data1, dembinary == 0)
model3_2 <- lm(wbge ~ lngdppc_new, data = interactions0)
summary(model3_2)

mtable(model3, model3_1, model3_2)
```

В модели, учитывающей только значения демократий(model3_1),  значение константы =-0.006, а значение коэффициента при предикторе lngdppc_new=0.802. В модели, учитывающей только значения НЕ-демократий(model3_2),  значение константы =-0.422, а значение коэффициента при предикторе lngdppc_new=0.378

Оценку константы модели, учитывающей только значения демократий, можно получить, если мы прибавим значение бинарной переменной dembinary к константе модели model3
Оценку переменной lngdppc_new модели, учитывающей только значения демократий, можно получить, если мы прибавим значение переменной взаимодействия к значению переменной lngdppc_new в модели model3